<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://code.angularjs.org/1.6.9/angular.min.js"></script>
    <script type="module" src="../../src/Cube.js"></script>
    <link rel="stylesheet" href="./style.css">
</head>
<body>

    <script type="module">
        import DimensionTable from './component/dimension-table.js'
        import CategoryTable from './component/category-table.js'
        import ProductTable from './model/ProductTable.js'
        import factTable from './data/factTable.js'
        import schema from './data/schema.js'

        window.angular.module('demo', [])
            .component('categoryTable', CategoryTable)
            .component('dimensionTable', DimensionTable)
            .controller('AppController', class DimensionTableController{
                constructor($scope){
                    $scope.factTable = factTable;
                    $scope.schema = schema;
                    $scope.cube = new ProductTable(factTable, schema);

                    $scope.qr_selectedYear = "";
                    $scope.$watch('qr_selectedYear', (value)=>{
                        $scope.qrTable = $scope.cube.getQr(value);
                    });

                    $scope.month_selectedQr = "";
                    $scope.$watch('month_selectedQr', (month_selectedQr)=>{
                        $scope.monthTable = $scope.cube.getMonth(month_selectedQr, $scope.month_selectedYear);
                    });

                    $scope.month_selectedYear = "";
                    $scope.$watch('month_selectedYear', (month_selectedYear)=>{
                        $scope.monthTable = $scope.cube.getMonth($scope.month_selectedQr, month_selectedYear);
                    });

                    const reset = () => {
                        $scope.marketTable = $scope.cube.getMarket();
                        $scope.productTable = $scope.cube.getProduct();
                        $scope.markTable = $scope.cube.getMark();
                        $scope.monthTable = $scope.cube.getMonth();
                        $scope.yearTable = $scope.cube.getYear();
                        $scope.qrMonthTable = $scope.cube.getQrMonth();
                        $scope.qrTable = $scope.cube.getQr();
                        $scope.yearQrMonthTable = $scope.cube.getYearQrMonth();
                        $scope.yearQrTable = $scope.cube.getYearQr();
                    };

                    reset();

                    $scope.$watch('cube', () => {
                        $scope.outputData = $scope.cube.getDataArray();
                    }, true);

                    $scope.toAdd = {
                        product: '',
                        market: '',
                        mark: '',
                        year: '',
                    };

                    $scope.addProduct = () => {
                        if ($scope.toAdd.product){
                            $scope.cube.addMember('product', { product: $scope.toAdd.product });
                            $scope.toAdd.product = '';
                            reset();
                        }
                    };
                    $scope.addMarket = () => {
                        if ($scope.toAdd.market){
                            $scope.cube.addMember('market', { market: $scope.toAdd.market });
                            $scope.toAdd.market = '';
                            reset();
                        }
                    };
                    $scope.addMark = () => {
                        if ($scope.toAdd.mark){
                            $scope.cube.addMember('mark', { mark: $scope.toAdd.mark });
                            $scope.toAdd.mark = '';
                            reset();
                        }
                    };
                    $scope.addYear = () => {
                        if ($scope.toAdd.year){
                            $scope.cube.addMember('year', { year: $scope.toAdd.year });
                            $scope.toAdd.year = '';
                            reset();
                        }
                    }

                }
            });

        window.angular.bootstrap(document, ['demo']);
    </script>

    <div ng-controller="AppController">

        <section>
            <h2>Fact Table <sup>(input data)</sup></h2>
            <dimension-table editable="false" table="factTable"></dimension-table>
        </section>

        <section>
            <h2>Fact Table <sup>(output data)</sup></h2>
            <button ng-click="cube.fill()">Make filling</button>
            <p>Current size: {{ cube.countOfPresent() }}</p>
            <p>Size of table after filling: {{ cube.countOfCardinality() }}</p>
            <p>Count of unfilling cells: {{ cube.countOfUnfilled() }}</p>
            <br/>
            <dimension-table editable="false" ng-if="outputData" table="outputData"></dimension-table>
        </section>

        <details open>
            <summary>
                Dimension Tables <sup>(output data)</sup>
            </summary>
            <section>
                <form>
                    <label ng-init="isAdd1=false" style="color:#ccc">
                        <input type="checkbox" ng-model="isAdd1"/>
                        Enable add mode
                        <input ng-if="isAdd1" ng-model="toAdd.product" placeholder="value to add" />
                        <button ng-if="isAdd1" ng-click="addProduct()">add</button>
                    </label>
                </form>
                <dimension-table editable="true" table="productTable"></dimension-table>
            </section>

            <section>
                <form>
                    <label ng-init="isAdd2=false" style="color:#ccc">
                        <input type="checkbox" ng-model="isAdd2"/>
                        Enable add mode
                        <input ng-if="isAdd2" ng-model="toAdd.market" placeholder="value to add" />
                        <button ng-if="isAdd2" ng-click="addMarket()">add</button>
                    </label>
                </form>
                <dimension-table editable="true" table="marketTable"></dimension-table>
            </section>

            <section>
                <form>
                    <label ng-init="isAdd3=false" style="color:#ccc">
                        <input type="checkbox" ng-model="isAdd3"/>
                        Enable add mode
                        <input ng-if="isAdd3" ng-model="toAdd.mark" placeholder="value to add" />
                        <button ng-if="isAdd3" ng-click="addMark()">add</button>
                    </label>
                </form>
                <dimension-table editable="true" table="markTable"></dimension-table>
            </section>

            <section>
                <form>
                    <label ng-init="isAdd4=false" style="color:#ccc">
                        <input type="checkbox" ng-model="isAdd4"/>
                        Enable add mode
                        <input ng-if="isAdd4" ng-model="toAdd.year" placeholder="value to add" />
                        <button ng-if="isAdd4" ng-click="addYear()">add</button>
                    </label>
                </form>
                <dimension-table editable="true" table="yearTable"></dimension-table>
            </section>
        </details>

        <details open>
            <summary>
                Specialized Dimension Tables <sup>(output data)</sup>
            </summary>

            <section>
                <dimension-table editable="true" table="qrTable"></dimension-table>
                <label>
                    <strong>year</strong>
                    <select ng-model="qr_selectedYear">
                        <option value="" selected>ALL</option>
                        <option ng-repeat="member in yearTable track by $index" value="{{member.year}}" >{{member.year}}</option>
                    </select>
                </label>
            </section>

            <section>
                <dimension-table editable="true" table="monthTable"></dimension-table>
                <label>
                    <strong>qr</strong>
                    <select ng-model="month_selectedQr">
                        <option value="" selected>ALL</option>
                        <option ng-repeat="member in qrTable track by $index" value="{{member.qr}}" >{{member.qr}}</option>
                    </select>
                </label>
                <label>
                    <strong>year</strong>
                    <select ng-model="month_selectedYear">
                        <option value="" selected>ALL</option>
                        <option ng-repeat="member in yearTable track by $index" value="{{member.year}}" >{{member.year}}</option>
                    </select>
                </label>

            </section>
        </details>

        <details open>
            <summary>
                Dimension Categories Tables<sup>(output data)</sup>
            </summary>

            <section>
                <category-table editable="true" table="yearQrMonthTable"></category-table>
            </section>

            <section>
                <category-table editable="true" table="yearQrTable"></category-table>
            </section>

            <section>
                <category-table editable="true" table="qrMonthTable"></category-table>
            </section>

        </details>

        <details open>
            <summary>
                Schema - aggregate data<sup>(input data)</sup>
            </summary>
            Dimension Hierarchy:
            <code style="white-space: pre">
                money
                    |- month
                        |- qr
                            |- year
                    |- product
                    |- market
                    |- mark
            </code>
        </details>

    </div>
</body>
</html>