!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):e.Cube=n()}(this,function(){"use strict";function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function v(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function r(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function n(e,n,t){return n&&r(e.prototype,n),t&&r(e,t),e}function y(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function d(n){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?arguments[e]:{},r=Object.keys(t);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(t).filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.forEach(function(e){y(n,e,t[e])})}return n}function i(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),n&&t(e,n)}function s(e){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function t(e,n){return(t=Object.setPrototypeOf||function(e,n){return e.__proto__=n,e})(e,n)}function a(e,n){if(null==e)return{};var t,r,i=function(e,n){if(null==e)return{};var t,r,i={},o=Object.keys(e);for(r=0;r<o.length;r++)t=o[r],0<=n.indexOf(t)||(i[t]=e[t]);return i}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)t=o[r],0<=n.indexOf(t)||Object.prototype.propertyIsEnumerable.call(e,t)&&(i[t]=e[t])}return i}function c(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function l(e,n){return!n||"object"!=typeof n&&"function"!=typeof n?c(e):n}function u(e,n,t){return(u="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,n,t){var r=function(e,n){for(;!Object.prototype.hasOwnProperty.call(e,n)&&null!==(e=s(e)););return e}(e,n);if(r){var i=Object.getOwnPropertyDescriptor(r,n);return i.get?i.get.call(t):i.value}})(e,n,t||e)}function m(e){return function(e){if(Array.isArray(e)){for(var n=0,t=new Array(e.length);n<e.length;n++)t[n]=e[n];return t}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}var f,p=function e(n,t){v(this,e),this.message="Can't add member, member for rollup dimension: ".concat(n," with id: ").concat(t," not found")},h=function e(n){v(this,e),this.message="In fact data, no property was found with the name: ".concat(n)},g=function e(){v(this,e),this.message="this must have prototype of Cube"},b=function e(n){v(this,e),this.message='For the name "'.concat(n,'" the dimension is already set')},T=console,k={log:function(e){T.log("[Cube] ".concat(e))},warn:function(e){T.warn("[Cube] ".concat(e))},warnOnce:(f={},function(e){f[e]||(f[e]=!0,T.warn("[Cube] ".concat(e)))})},O=function e(n){v(this,e);try{for(var t in n){if(!n.hasOwnProperty(t))return;r=n[t],void 0,"object"!==(i=o(r))&&"function"!==i&&"undefined"!==i||null===r?this[t]=n[t]:k.warn('[Fact] value of prop "'.concat(t,'" has an unspecified value: ').concat(n[t]))}}catch(e){!function(e){throw e.message="[Cube] ".concat(e.message),e}(e)}var r,i},D=function(e){function n(){return v(this,n),l(this,s(n).apply(this,arguments))}return i(n,O),n}();var w=function(e){function t(e,n){return v(this,t),e.id||(e.id=t.generateId()),l(this,s(t).call(this,e,n))}return i(t,D),n(t,null,[{key:"createEmptyCell",value:function(e){return new t(e)}},{key:"isEmptyCell",value:function(e){return"string"==typeof e.id}},{key:"generateId",value:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var n=16*Math.random()|0;return("x"==e?n:3&n|8).toString(16)})}}]),t}(),E=function(){function o(e){v(this,o),Object.assign(this,e)}return n(o,null,[{key:"create",value:function(e,n,t,r){if(this!==o&&!o.isPrototypeOf(this))throw Error("this.constructor must be prototype of Member");var i={};return i[r]=e,n.forEach(function(e){e!==r&&(i[e]=t[e])}),new this(i)}}]),o}(),C=function(e){function o(){return v(this,o),l(this,s(o).apply(this,arguments))}return i(o,E),n(o,null,[{key:"create",value:function(e,n,t,r){var i={};return n.forEach(function(e){i[e]=t.hasOwnProperty(e)?t[e]:null}),u(s(o),"create",this).call(this,e,n,i,r)}}]),o}(),M=function(){function y(e){var n=this,t=e.dimension,r=e.foreignKey,i=void 0===r?y.genericId(t):r,o=e.primaryKey,a=void 0===o?"id":o,u=e.keyProps,s=e.otherProps,c=void 0===s?[]:s,l=e.members,f=void 0===l?[]:l,h=e.defaultMemberOptions,m=void 0===h?{}:h;if(v(this,y),!t||!u)throw Error('Bad definition DimensionTable, params "dimension" and "keyProps" is required');if(-1!==Object.keys(m).indexOf(a))throw Error('Bad definition DimensionTable, "defaultMemberOptions" must not contain a "primaryKey" property');this.dimension=t,this.foreignKey=i,this.primaryKey=a,this.keyProps=[].concat(u),this.otherProps=[].concat(c),this.members=f.map(function(e){return new E(e,n.primaryKey)}),this.defaultMemberOptions=d({},m)}return n(y,[{key:"setMemberList",value:function(e){[].splice.apply(this.members,[0,this.members.length].concat(e))}},{key:"clearMemberList",value:function(){this.members=[]}},{key:"getMemberId",value:function(e){return e[this.primaryKey]}},{key:"addMember",value:function(e){-1===this.members.indexOf(e)?this.members.push(e):console.log("boo")}},{key:"createMember",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},n=1<arguments.length?arguments[1]:void 0,t=d({},this.defaultMemberOptions,e),r=this.keyProps,i=this.otherProps,o=this.members,a=this.primaryKey,u=r.concat(n).concat(i),s=y.reduceId(o,a),c=C.create(s,u,t,a);return this.addMember(c),c}},{key:"setMemberId",value:function(e,n){e[this.primaryKey]=n}},{key:"deleteMemberId",value:function(e){delete e[this.primaryKey]}},{key:"removeMember",value:function(e){var n=this.members.indexOf(e);if(-1===n)throw new Error("represented member was not found",e);this.members.splice(n,1)}}],[{key:"reduceId",value:function(e,t){return e.length?e.reduce(function(e,n){return e[t]>n[t]?e:n},0)[t]+1:1}},{key:"genericId",value:function(e){return"%s_id".replace("%s",e)}},{key:"createDimensionTable",value:function(e){return new y(e)}}]),y}(),P=function(){function e(){v(this,e)}return n(e,[{key:"getTreeValue",value:function(){throw"abstract method"}},{key:"getParentTree",value:function(){throw"abstract method"}},{key:"getChildTrees",value:function(){throw"abstract method"}},{key:"isExternal",value:function(){return!this.getChildTrees().length}},{key:"isRoot",value:function(){return null===this.getParentTree()}},{key:"getRoot",value:function(){var n=this;return this.traceUpOrder(function(e){e.isRoot()&&(n=e)}),n}},{key:"searchTreeByTreeValue",value:function(t){var r=void 0;return this.tracePostOrder(function(e,n){t(n)&&(r=n)}),r}},{key:"traceUpOrder",value:function(r){!function e(n){var t=n.getParentTree();r(n),null!==t&&e(t)}(this)}},{key:"tracePostOrder",value:function(i){!function n(e){var t=e.getChildTrees(),r=e.getTreeValue();t.length&&t.forEach(function(e){n(e)}),i(r,e)}(this)}},{key:"tracePreOrder",value:function(i){!function n(e){var t=e.getChildTrees(),r=e.getTreeValue();i(r,e),t.length&&t.forEach(function(e){n(e)})}(this)}},{key:"hasChild",value:function(t){var r=!1;return this.tracePreOrder(function(e,n){n===t&&(r=!0)}),r}},{key:"hasParent",value:function(n){var t=!1;return this.traceUpOrder(function(e){e===n&&(t=!0)}),t}}]),e}(),j=function(e){function u(e){var n;v(this,u),n=l(this,s(u).call(this));var t=e.dimensionTable,r=e.level,i=void 0===r?[]:r,o=e.parentNode,a=void 0===o?null:o;return Object.defineProperties(c(c(n)),{dimensionTable:{value:M.createDimensionTable(t),editable:!1,enumerable:!0},parentNode:{value:a,enumerable:!1,editable:!1},level:{value:i.map(function(e){return new u(d({},e,{parentNode:c(c(n))}))}),enumerable:!0,editable:!1}}),n.validate(),n}return i(u,P),n(u,[{key:"validate",value:function(){var t=[];this.tracePostOrder(function(e){var n=e.dimension;if(-1!==t.indexOf(n))throw new b;t.push(n)})}},{key:"getTreeValue",value:function(){return this.dimensionTable}},{key:"getParentTree",value:function(){return this.parentNode}},{key:"getChildTrees",value:function(){return this.level}},{key:"getDimensionTreeByDimension",value:function(n){return this.getRoot().searchTreeByTreeValue(function(e){return e.getTreeValue().dimension===n})}},{key:"createProjectionOntoMember",value:function(e){var n=this.cloneDimensionTreeWithoutMembers();return this.projectDrillDown(n,e),this.projectDrillUp(n,e),n}},{key:"projectDrillDown",value:function(r,i){var o,a,u=this;this.traceUpOrder(function(e){var n=e.getTreeValue().dimension,t=e==u?[i]:a.drillDownDimensionMembers(o);r.getDimensionTreeByDimension(n).getTreeValue().setMemberList(t),o=t,a=e})}},{key:"projectDrillUp",value:function(i,o){var a,u,s=this;this.tracePreOrder(function(e,n){var t=n.getTreeValue().dimension,r=n==s?[o]:u.drillUpDimensionMembers(a);i.getDimensionTreeByDimension(t).getTreeValue().setMemberList(r),a=r,u=n})}},{key:"cloneDimensionTreeWithoutMembers",value:function(){var e=new u(this.getRoot());return e.tracePostOrder(function(e,n){n.getTreeValue().clearMemberList()}),e}},{key:"removeProjectionOntoMember",value:function(e){var n=this.cloneDimensionTreeWithoutMembers();this.projectDrillDown(n,e),this.subtractDimensionTree(n);var t={},r=n.getRoot().getTreeValue(),i=r.dimension,o=r.members;return t[i]=o,t}},{key:"subtractDimensionTree",value:function(e){var t=this,i={};e.tracePostOrder(function(e){var n=e.dimension,t=e.members;i[n]=t}),1===this.getTreeValue().members.length&&this.tracePreOrder(function(e,n){var t=e.members,r=e.dimension;i[r]=t}),Object.keys(i).forEach(function(e){var n=t.getDimensionTreeByDimension(e).getTreeValue();i[e].forEach(function(e){n.removeMember(e)})})}},{key:"unionDimensionTree",value:function(e){var t=this,r={};e.tracePostOrder(function(e){var n=e.dimension,t=e.members;r[n]=t});this.getTreeValue().members;Object.keys(r).forEach(function(e){var n=t.getDimensionTreeByDimension(e).getTreeValue();r[e].forEach(function(e){n.addMember(e)})})}},{key:"drillDownDimensionMembers",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:this.getTreeValue().members;if(this.isRoot())return e;var n=this.getParentTree().getTreeValue(),t=n.members,r=n.primaryKey,i=this.getTreeValue().foreignKey,o=[];return e.forEach(function(n){t.forEach(function(e){e[i]===n[r]&&-1===o.indexOf(e)&&o.push(e)})}),o}},{key:"drillUpDimensionMembers",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:this.getTreeValue().members;if(this.isExternal())return e;var t=this.getChildTrees()[0].getTreeValue(),r=t.members,i=t.foreignKey,o=[];return e.forEach(function(n){r.forEach(function(e){n[i]===t.getMemberId(e)&&-1===o.indexOf(e)&&o.push(e)})}),o}},{key:"createMember",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},n=this.getTreeValue(),t=this.getChildTrees().map(function(e){return e.getTreeValue().foreignKey}),r=[];return t.forEach(function(e){r.push(e)}),n.createMember(e,r)}}],[{key:"createDimensionTree",value:function(e){return new u(e)}},{key:"createProxyDimensionTree",value:function(e){var r=e.cloneDimensionTreeWithoutMembers();return e.tracePostOrder(function(e){var n=e.dimension,t=e.members;r.getDimensionTreeByDimension(n).getTreeValue().setMemberList(t)}),r}}]),u}(),x=function(){function i(e){var n=e.dimensionTree,t=e.activeDimension,r=e.hierarchy;if(v(this,i),!r)throw Error('attribute "hierarchy" must be defined');this.dimensionTree=n instanceof j?n:j.createDimensionTree(n),this.activeDimension=t||this.dimensionTree.getTreeValue().dimension,this.hierarchy=r}return n(i,[{key:"getDimensionTree",value:function(){return this.dimensionTree}},{key:"hasDimension",value:function(e){return!!this.dimensionTree.getDimensionTreeByDimension(e)}},{key:"getActiveDimension",value:function(){return this.activeDimension}},{key:"setActiveDimension",value:function(e){this.activeDimension=e}},{key:"getHierarchy",value:function(){return this.hierarchy}}],[{key:"createDimensionHierarchy",value:function(e){return new i(e)}}]),i}(),V=function(){function a(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},n=e.facts,t=void 0===n?[]:n,r=e.primaryKey,i=void 0===r?"id":r,o=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};v(this,a),this.primaryKey=i,this.facts=t.map(function(e){return new O(e)}),this.defaultFactOptions=o,this.facts.forEach(this.validateFactData.bind(this))}return n(a,[{key:"getFacts",value:function(){return this.facts}},{key:"validateFactData",value:function(e){if(!e.hasOwnProperty(this.primaryKey))throw new h(this.primaryKey)}}],[{key:"deleteProps",value:function(n,e,t){e.forEach(function(e){e!==t&&delete n[e]})}}]),a}(),K=function(){function O(){v(this,O)}return n(O,null,[{key:"anotherBuild",value:function(n,t,e,r,i){e.forEach(function(e){O.anotherBuildOne(e,t,r,n,i)})}},{key:"anotherBuildOne",value:function(e,t,r,i,o){e.tracePostOrder(function(e,n){O.processDimension(n,t,r,i,o)})}},{key:"processDimension",value:function(e,n,t,r,i){var o,a=e.getTreeValue(),u=a.dimension,s=a.keyProps,c=void 0===s?[]:s,l=a.otherProps,f=void 0===l?[]:l,h=a.members,m=a.foreignKey,y=a.primaryKey,v=e.getChildTrees().map(function(e){return e.getTreeValue().foreignKey}),d=e.getChildTrees().map(function(e){return e.getTreeValue().dimension}),p=h.length,g=[i,y,m,p,r,n,u,c,f,n,t];if(v.length){var b,T=e.getDimensionTreeByDimension(d[0]).getTreeValue(),k=T.members;b=O.mapFilter(v[0],n,k,T),o=O.makeMemberListLevel.apply(null,g.concat([v,b]))}else o=O.makeMemberList.apply(null,g);n.forEach(function(e){V.deleteProps(e,c,i),V.deleteProps(e,f,i)}),o.forEach(function(e){a.addMember(e)})}},{key:"mapFilter",value:function(t,r,e,i){var o=[];return e.forEach(function(n){var e=r.filter(function(e){return e[t]==i.getMemberId(n)});o.push(e)}),o}},{key:"makeMemberListLevel",value:function(n,i,o,a,u,e,s,c,l,f,h,m,t){var y=[],v=0;return t.forEach(function(e){if(e.length){var t=O.makeMemberList(n,i,o,a,u,e,s,c,l,f,h,v);v+=t.length;var r=e[0];m.forEach(function(n){t.forEach(function(e){e[n]=r[n],e[i]=a+y.length+1,y.push(e)}),e.forEach(function(e){delete e[n]})})}}),y}},{key:"makeMemberList",value:function(r,i,o,e,a,u,n){var s=7<arguments.length&&void 0!==arguments[7]?arguments[7]:[],c=8<arguments.length&&void 0!==arguments[8]?arguments[8]:[],t=9<arguments.length?arguments[9]:void 0,l=10<arguments.length?arguments[10]:void 0,f=11<arguments.length&&void 0!==arguments[11]?arguments[11]:0,h={},m={},y=[];return l.filter(function(e){return-1===t.indexOf(e)}).forEach(function(n){var e=a.find(function(e){return e[r]===n[r]}),t=O.createKeyFromProps(s,e);t in m||(m[t]=++f)}),u.forEach(function(e){var n=O.createKeyFromProps(s,e);n in h||n in m||(h[n]=++f);var t=h[n];e[o]=t}),Object.keys(h).forEach(function(e){var n=h[e],t=u.find(function(e){return e[o]===n}),r=E.create(n,[].concat(s).concat(c),t,i);y.push(r)}),y}},{key:"createKeyFromProps",value:function(e,n){return e.map(function(e){return n[e]}).join(",")}},{key:"destroy",value:function(t,e,r,i){var o=this;e.forEach(function(e){var n=t.indexOf(e);-1!==n&&t.splice(n,1)}),e.forEach(function(n){r.forEach(function(e){O.travers([n],e,[O.removeMembers.bind(o,i,e),O.restoreCell])})})}},{key:"denormalize",value:function(e,t){var n=(new V).getFacts();return e.forEach(function(e){n.push(d({},e))}),n.forEach(function(n){t.forEach(function(e){O.travers([n],e,[O.restoreCell])})}),n}},{key:"restoreCell",value:function(e,n,t,r,i,o){var a=new E(e);o.deleteMemberId(a),delete r[i],Object.assign(r,a)}},{key:"removeMembers",value:function(e,n,t,r,i,o,a){var u=e.dice(y({},i,t)),s=n.getDimensionTreeByDimension(i).getTreeValue();u.getCells().length||s.removeMember(t)}},{key:"travers",value:function(e,n){var l=2<arguments.length&&void 0!==arguments[2]?arguments[2]:function(){};e.forEach(function(c){n.tracePreOrder(function(e,n){var t,r,i,o,a,u,s;t=c,r=n.getTreeValue(),i=r.dimension,o=r.members,a=r.foreignKey,u=t[a],s=o.find(function(e){return r.getMemberId(e)===u}),l.forEach(function(e){e(s,o,i,t,a,r)})})})}},{key:"destroyDimensionTree",value:function(e,n,t,r){O.travers(e,t,[O.removeMembers.bind(this,r,t),O.restoreCell])}}]),O}(),F=function e(n){v(this,e),Object.assign(this,n)},I=function(){function t(){v(this,t)}return n(t,null,[{key:"union",value:function(){var n={};return Array.prototype.slice.call(arguments).forEach(function(e){t.add(n,e)}),n}},{key:"add",value:function(n,t){Object.keys(t).forEach(function(e){n[e]||(n[e]=[]),Array.prototype.push.apply(n[e],t[e])})}}]),t}(),B=function e(n){var t=n.cells,r=n.primaryKey,i=n.defaultFactOptions,o=void 0===i?{}:i;v(this,e),this.cells=t.map(function(e){return e instanceof D?e:w.isEmptyCell(e)?new w(e):new D(e)}),this.primaryKey=r,this.defaultFactOptions=o},H=function(){function h(e){v(this,h);var n=e.dimensionHierarchies,t=void 0===n?[]:n,r=e.cellTable,i=void 0===r?{}:r;Array.isArray(i)&&(i={cells:i},k.warnOnce('first argument "cells" as array type is deprecated now, use object for describe fact table'));var o=i,a=o.cells,u=void 0===a?[]:a,s=o.primaryKey,c=void 0===s?"id":s,l=o.defaultFactOptions,f=void 0===l?{}:l;this.dimensionHierarchies=t.map(function(e){return e.hierarchy?e instanceof x?e:x.createDimensionHierarchy(e):e.dimensionTable?e instanceof j?e:j.createDimensionTree(e):e instanceof M?e:M.createDimensionTable(e)}),this.cellTable=new B({cells:u,primaryKey:c,defaultFactOptions:d({},f)})}return n(h,[{key:"slice",value:function(e,n){return this.dice(y({},e,n))}},{key:"dice",value:function(n){var u=this,a={};Object.keys(n).forEach(function(r){a[r]=Array.isArray(n[r])?n[r]:[n[r]];var e=L.call(u,r);if(e){var i=e.getTreeValue();a[r].forEach(function(n,e){var t=u.getDimensionMembers(r).find(function(e){return i.getMemberId(e)===i.getMemberId(n)});a[r][e]=t,n||k.warn("Not found member by id ".concat(i.getMemberId(t)))})}else k.warn("Not existed dimension: ".concat(r))});var e=this.dimensionHierarchies.length;if(Object.keys(a).length>e)throw Error("Set must have a size not more than ".concat(e," dimensions"));var s=[],t=Object.keys(a).map(function(i){var o,e=a[i].map(function(e){var n=L.call(u,i),t=n.cloneDimensionTreeWithoutMembers();n.projectDrillDown(t,e),n.projectDrillUp(t,e),o?o.unionDimensionTree(t):o=t;var r=o.getRoot().getTreeValue();return y({},r.dimension,r.members)});return o&&s.push(o),I.union.apply(I,m(e))}),c=this.getCells(),l=function(o,a){return!Object.keys(a).some(function(e){var n=a[e],t=L.call(u,e).getTreeValue(),r=t.foreignKey,i=t.primaryKey;return!n.find(function(e){return e[i]===o[r]})})};t.forEach(function(n){c=c.filter(function(e){return l(e,n)})});var f=[];return this.dimensionHierarchies.forEach(function(n){var t=!1;if(s.forEach(function(e){n.getTreeValue().dimension===e.getTreeValue().dimension&&(f.push(e),t=!0)}),!t){var e=n.getTreeValue(),r=e.members,i=e.dimension,o=j.createProxyDimensionTree(n);r.forEach(function(n){var t=!1;(c.forEach(function(e){l(e,y({},i,[n]))&&(t=!0)}),t)||-1!==o.getTreeValue().members.indexOf(n)&&o.removeProjectionOntoMember(n)}),f.push(o)}}),new A({cellTable:c,dimensionHierarchies:f,originalCube:this.originalCube||this,previousCube:this})}},{key:"drillUp",value:function(e,n){var t=S.call(this,e);return t&&t.hasDimension(n)&&t.setActiveDimension(n),this}},{key:"drillDown",value:function(e,n){var t=S.call(this,e);return t&&t.hasDimension(n)&&t.setActiveDimension(n),this}},{key:"getFacts",value:function(){return function(){var t=this,r=0<arguments.length&&void 0!==arguments[0]?arguments[0]:this.getCells(),e=!(1<arguments.length&&void 0!==arguments[1])||arguments[1],n=K.denormalize(r,R.call(this));e&&n.forEach(function(e,n){r[n]instanceof w&&delete e[t.cellTable.primaryKey]});return n}.call(this,this.getCells())}},{key:"addFacts",value:function(e){var n=new V({facts:e,primaryKey:this.cellTable.primaryKey}).getFacts().map(function(e){return new D(e)});[].push.apply(this.getCells(),n);var t=this.getFacts();return K.anotherBuild(t,n,R.call(this),this.getCells(),this.cellTable.primaryKey),this}},{key:"removeFacts",value:function(e){var t=this.getCells(),r=this.cellTable.primaryKey,n=e.map(function(n){return t.find(function(e){return e[r]===n[r]})});this.removeCells(n)}},{key:"getCells",value:function(){return this.cellTable.cells}},{key:"removeCells",value:function(e){K.destroy(this.getCells(),e,this.dimensionHierarchies,this)}},{key:"getDimensionMembers",value:function(e){return L.call(this,e).getTreeValue().members}},{key:"addDimensionMember",value:function(e){var o=this,n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},a=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},u=3<arguments.length&&void 0!==arguments[3]?arguments[3]:{},t=4<arguments.length?arguments[4]:void 0;if("string"!=typeof e)throw TypeError("parameter dimension expects as string: ".concat(e));Object.keys(a).forEach(function(e){var n=a[e],t=o.getDimensionMembers(e),r=L.call(o,e).getTreeValue(),i=n[r.primaryKey];if(!t.find(function(e){return i===r.getMemberId(e)}))throw new p(e,i)});var s=L.call(this,e),r=s.getChildTrees(),c=s.getTreeValue(),i=c.foreignKey,l={};r.forEach(function(e){var n=e.getTreeValue(),t=n.dimension,r=n.foreignKey,i=n.primaryKey,o=a[t];if(!o)throw new p(t);l[r]=o[i]});var f=Object.assign({},n,l),h=s.createMember(f),m=i;s.traceUpOrder(function(e){if(s!==e){var n=e.getTreeValue(),t=n.dimension,r=n.foreignKey,i=y({},m,c.getMemberId(h));Object.assign(i,u[t]),h=e.createMember(i),m=r}}),this.fillEmptyCells(t)}},{key:"removeDimensionMember",value:function(e,n){var a=L.call(this,e),u=a.removeProjectionOntoMember(n),s=this.getCells();Object.keys(u).map(function(e){var n,t,r,i,o;(t=u[n=e],r=[],i=a.getDimensionTreeByDimension(n).getTreeValue(),o=i.foreignKey,s.forEach(function(n){t.forEach(function(e){n[o]==i.getMemberId(e)&&r.push(n)})}),r).forEach(function(e){var n=s.indexOf(e);-1!==n&&s.splice(n,1)})})}},{key:"addDimensionHierarchy",value:function(e){var n=j.createDimensionTree(e);this.dimensionHierarchies.push(n),K.anotherBuildOne(n,this.getCells(),this.getCells(),this.getCells(),this.cellTable.primaryKey)}},{key:"removeDimensionHierarchy",value:function(e){K.destroyDimensionTree(this.getCells(),this.getCells(),e,this),this.dimensionHierarchies.splice(this.dimensionHierarchies.indexOf(e),1)}},{key:"createEmptyCells",value:function(t){var o=this,a=[];return h.cartesian(this).forEach(function(r){if(!o.dice(r).getCells().length){var i={};Object.keys(r).forEach(function(e){var n=L.call(o,e).getTreeValue(),t=n.foreignKey;i[t]=n.getMemberId(r[e])});var e=d({},i,t),n=w.createEmptyCell(e);a.push(n)}}),a}},{key:"getEmptyCells",value:function(){return this.getCells().filter(function(e){return w.isEmptyCell(e)})}},{key:"isEmptyCell",value:function(e){return w.isEmptyCell(e)}},{key:"addEmptyCells",value:function(e){h.validateInstance(e),[].push.apply(this.getCells(),e)}},{key:"fillEmptyCells",value:function(){var n,e,t,r=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},i=d({},this.cellTable.defaultFactOptions,r);if(!(n=this,e=H.cartesian(n),t=[],e.forEach(function(e){1<n.dice(e).getFacts().length&&t.push(e)}),t).length){var o=this.createEmptyCells(i);this.addEmptyCells(o)}}},{key:"isSubCube",value:function(){return this instanceof A}}],[{key:"create",value:function(e){var n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[];Array.isArray(e)&&(e={facts:e},k.warnOnce('first argument "facts" as array type is deprecated now, use object for describe fact table'));var t=e,r=t.facts,i=void 0===r?[]:r,o=t.primaryKey,a=t.defaultFactOptions,u=void 0===a?{}:a;if(!h.isPrototypeOf(this)&&h!==this)throw new g;var s=new this({cellTable:{primaryKey:o,defaultFactOptions:u},dimensionHierarchies:n});return s.addFacts(i),s}},{key:"validateInstance",value:function(e){e.forEach(function(e){if(!(e instanceof w))throw new TypeError("some item in list of argument is not instances of EmptyCell")})}},{key:"cartesian",value:function(e){var n=function e(n,t){for(var r=arguments.length,i=new Array(2<r?r-2:0),o=2;o<r;o++)i[o-2]=arguments[o];return t?e.apply(void 0,[(a=n,u=t,(s=[]).concat.apply(s,m(a.map(function(n){return u.map(function(e){return[].concat(n,e)})}))))].concat(i)):n;var a,u,s},i=[],t=e.dimensionHierarchies.map(function(e){return e.getTreeValue()}).map(function(e){return i.push(e.dimension),e.members}),o=[];return t.length&&(1<t.length?n.apply(null,t):t[0].map(function(e){return[e]})).forEach(function(t){var r={};return i.forEach(function(e,n){r[e]=t[n]}),o.push(new F(r)),r}),o}}]),h}(),A=function(e){function o(e){var n,t=e.originalCube,r=e.previousCube,i=a(e,["originalCube","previousCube"]);return v(this,o),(n=l(this,s(o).call(this,i))).originalCube=t,n.previousCube=r,n}return i(o,H),o}();function S(n){return this.dimensionHierarchies.find(function(e){return e.getHierarchy()===n})}function L(n){var t;return this.dimensionHierarchies.forEach(function(e){e.getDimensionTreeByDimension(n)&&(t=e.getDimensionTreeByDimension(n))}),t}function R(){return this.dimensionHierarchies.map(function(e){return e.getDimensionTree?e.getDimensionTree():e})}return H});
//# sourceMappingURL=cube.min.js.map
